#######################################################################################################################
#######################################################################################################################
# Title:        PWM Distortion Toolkit for Standard Topologies
# Topic:        Power Electronics
# File:         calcElecCap
# Date:         01.05.2024
# Author:       Dr. Pascal A. Schirmer
# Version:      V.1.0
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Function Description
#######################################################################################################################
"""
This function calculates the electrical output of the capacitor at the dc link.
Inputs:     1) t:       time domain vector (sec)
            2) i_c:     time domain capacitor current (A)
            3) Tj:      core temperature of the capacitor (Â°C)
            4) para:    all parameters of the capacitor
            5) setup:   all setup variables
Outputs:    1) v_dc:    time domain capacitor voltage (V)
"""

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================

# ==============================================================================
# External
# ==============================================================================
import numpy as np
from scipy import interpolate
from scipy import signal


#######################################################################################################################
# Function
#######################################################################################################################
def calcElecCap(t, i_c, Tj, para, setup):
    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    # ==============================================================================
    # Parameters
    # ==============================================================================
    dt = t[1] - t[0]
    fel = setup['Top']['fel']

    # ==============================================================================
    # Variables
    # ==============================================================================
    f = np.linspace(0, int(1/dt), int(len(i_c)/2))
    t = np.linspace(0, 2/fel, len(i_c)*2-1)

    ###################################################################################################################
    # Pre-Processing
    ###################################################################################################################
    # ==============================================================================
    # Double i_c
    # ==============================================================================
    i_c = np.concatenate((i_c[0:-1], i_c), axis=0)

    # ==============================================================================
    # Get Fundamental Frequency
    # ==============================================================================
    idx = np.argmin(f-2*fel)

    # ==============================================================================
    # Extract Parameters
    # ==============================================================================
    # ------------------------------------------
    # Constant
    # ------------------------------------------
    if setup['Par']['Elec']['CapMdl'] == "con" or setup['Par']['Elec']['SwiMdl'] == "pwl":  
        ESR = para['Cap']['Elec']['con']['ESR']
        C = para['Cap']['Elec']['con']['C']
        
    # ------------------------------------------
    # Tabular
    # ------------------------------------------
    elif setup['Par']['Elec']['CapMdl'] == "tab":
        # Matrix 
        ESR_2d = interpolate.interp2d(para['Cap']['Elec']['vec']['Tj'].to_numpy(), para['Cap']['Elec']['vec']['f'].to_numpy(), para['Cap']['Elec']['tab']['ESR'].to_numpy(), kind='linear')
        C_2d = interpolate.interp2d(para['Cap']['Elec']['vec']['Tj'].to_numpy(), para['Cap']['Elec']['vec']['f'].to_numpy(), para['Cap']['Elec']['tab']['C'].to_numpy(), kind='linear')

        # Fundamental Value
        ESR = ESR_2d(Tj, f[idx])
        C = C_2d(Tj, f[idx])

        # Static
        ESR = ESR[0]
        C = C[0]

    # ------------------------------------------
    # Default
    # ------------------------------------------
    else:
        ESR = para['Cap']['Elec']['con']['ESR']
        C = para['Cap']['Elec']['con']['C']

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    tf = signal.TransferFunction([ESR*C, 1], [C, 0])
    _, v_dc, _, = signal.lsim(tf, i_c, t)

    ###################################################################################################################
    # Post-Processing
    ###################################################################################################################
    v_dc = v_dc[int(len(i_c)/2)-1:-1]

    ###################################################################################################################
    # Return
    ###################################################################################################################
    return v_dc
