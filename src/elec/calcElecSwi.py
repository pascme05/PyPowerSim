#######################################################################################################################
#######################################################################################################################
# Title:        PWM Distortion Toolkit for Standard Topologies
# Topic:        Power Electronics
# File:         calcElecSwi
# Date:         14.08.2023
# Author:       Dr. Pascal A. Schirmer
# Version:      V.0.2
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================

# ==============================================================================
# External
# ==============================================================================
import numpy as np
import pandas as pd
import copy
import multiprocessing
from functools import partial


#######################################################################################################################
# Function
#######################################################################################################################
def calcElecSwi(Vdc, Is, G, Tj, pos, para, setupPara):
    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    # ==============================================================================
    # Parameters
    # ==============================================================================
    Vf = para['Swi']['Elec']['con']['Vf']
    Ron = para['Swi']['Elec']['con']['Ron']
    Vfd = para['Swi']['Elec']['con']['Vfd']
    RonD = para['Swi']['Elec']['con']['RonD']

    # ==============================================================================
    # Output
    # ==============================================================================
    out = pd.DataFrame(columns=['i_T', 'v_T', 'i_D', 'v_D'])

    ###################################################################################################################
    # Pre-Processing
    ###################################################################################################################
    # ==============================================================================
    # Extract parameters
    # ==============================================================================
    # ------------------------------------------
    # Constant
    # ------------------------------------------
    if setupPara['Elec']['SwiMdl'] == "con":
        # IGBT
        if setupPara['Elec']['SwiType'] == "IGBT":
            VfT = Vf * np.ones(np.size(Is))
            VfD = Vfd * np.ones(np.size(Is))

        # MOSFET
        else:
            VfT = Vf * np.ones(np.size(Is))
            VfD = Vfd * np.ones(np.size(Is))

    # ------------------------------------------
    # Piece-wise linear (tbi)
    # ------------------------------------------
    elif setupPara['Elec']['SwiMdl'] == "pwl":
        # IGBT
        if setupPara['Elec']['SwiType'] == "IGBT":
            VfT = Vf + Ron * np.abs(Is)
            VfD = Vfd + RonD * np.abs(Is)

        # MOSFET
        else:
            VfT = Ron * np.abs(Is)
            VfD = Vfd + RonD * np.abs(Is)

    # ------------------------------------------
    # Tabular
    # ------------------------------------------
    else:
        pool = multiprocessing.Pool(processes=None)
        Vce_2d = partial(para['Swi']['Elec']['tab']['Vce_2d'], Tj)
        Vfd_2d = partial(para['Swi']['Elec']['tab']['Vfd_2d'], Tj)
        VfT = np.array(pool.map(Vce_2d, abs(Is)))[:, 0]
        VfD = np.array(pool.map(Vfd_2d, abs(Is)))[:, 0]

    # ==============================================================================
    # Parameterize PWM Method
    # ==============================================================================
    if setupPara['PWM']['type'] == 0:
        VfT = np.zeros(np.size(Is))
        VfD = np.zeros(np.size(Is))

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    # ==============================================================================
    # Transistor
    # ==============================================================================
    if pos == 'HS':
        # ------------------------------------------
        # Voltage
        # ------------------------------------------
        v_T = Vdc * (~G).astype(float)
        v_T[Is > 0] = v_T[Is > 0] + (VfT[Is > 0]) * (G[Is > 0]).astype(float) + (VfD[Is > 0]) * (~G[Is > 0]).astype(float)
        v_T[Is <= 0] = v_T[Is <= 0] - (VfT[Is <= 0]) * (~G[Is <= 0]).astype(float) - (VfD[Is <= 0]) * (G[Is <= 0]).astype(float)

        # ------------------------------------------
        # Current
        # ------------------------------------------
        i_T = Is * G.astype(float)
        if setupPara['Elec']['SwiRecCon'] == "D":
            i_T[Is < 0] = 0
        else:
            i_T[Is < 0] = i_T[Is < 0] * (VfD[Is < 0] / (VfD[Is < 0] + VfT[Is < 0]))
    else:
        # ------------------------------------------
        # Voltage
        # ------------------------------------------
        v_T = Vdc * (~G).astype(float)
        v_T[Is <= 0] = v_T[Is <= 0] + (VfT[Is <= 0]) * (G[Is <= 0]).astype(float) + (VfD[Is <= 0]) * (~G[Is <= 0]).astype(float)
        v_T[Is > 0] = v_T[Is > 0] - (VfT[Is > 0]) * (~G[Is > 0]).astype(float) - (VfD[Is > 0]) * (G[Is > 0]).astype(float)

        # ------------------------------------------
        # Current
        # ------------------------------------------
        i_T = Is * G.astype(float) * (-1)
        if setupPara['Elec']['SwiRecCon'] == "D":
            i_T[Is > 0] = 0
        else:
            i_T[Is > 0] = i_T[Is > 0] * (VfD[Is > 0] / (VfD[Is > 0] + VfT[Is > 0]))

    # ==============================================================================
    # Diode
    # ==============================================================================
    if pos == 'HS':
        # ------------------------------------------
        # Voltage
        # ------------------------------------------
        v_D = -v_T

        # ------------------------------------------
        # Current
        # ------------------------------------------
        i_D = -copy.deepcopy(Is)
        i_D[Is > 0] = 0
        if setupPara['Elec']['SwiRecCon'] == "D":
            # HS Gate 0/1
            i_D[v_D < 0] = 0
        else:
            # HS Gate 0
            i_D[v_D < 0] = 0

            # HS Gate 1
            i_D = i_D * (VfT / (VfD + VfT))

            # Blanking time
            if setupPara['Elec']['SwiRecMdl'] == 1:
                i_D[(VfT > VfD) & (G.astype(float) == 1)] = 0

    else:
        # ------------------------------------------
        # Voltage
        # ------------------------------------------
        v_D = -v_T

        # ------------------------------------------
        # Current
        # ------------------------------------------
        i_D = copy.deepcopy(Is)
        i_D[Is < 0] = 0
        if setupPara['Elec']['SwiRecCon'] == "D":
            # HS Gate 0/1
            i_D[v_D < 0] = 0
        else:
            # HS Gate 0
            i_D[v_D < 0] = 0

            # HS Gate 1
            i_D = i_D * (VfT / (VfD + VfT))

            # Blanking time
            if setupPara['Elec']['SwiRecMdl'] == 1:
                i_D[(VfT > VfD) & ((~G).astype(float) == 1)] = 0

    ###################################################################################################################
    # Post-Processing
    ###################################################################################################################
    # ==============================================================================
    # Output
    # ==============================================================================
    # ------------------------------------------
    # Transistor
    # ------------------------------------------
    out['v_T'] = v_T / setupPara['Elec']['SwiSeries']
    out['i_T'] = i_T / setupPara['Elec']['SwiPara']

    # ------------------------------------------
    # Diode
    # ------------------------------------------
    out['v_D'] = v_D / setupPara['Elec']['SwiSeries']
    out['i_D'] = i_D / setupPara['Elec']['SwiPara']

    ###################################################################################################################
    # Return
    ###################################################################################################################
    return out
