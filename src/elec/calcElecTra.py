#######################################################################################################################
#######################################################################################################################
# Title:        PWM Distortion Toolkit for Standard Topologies
# Topic:        Power Electronics
# File:         calcElecTra
# Date:         08.02.2026
# Author:       Dr. Pascal A. Schirmer
# Version:      V.1.0
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Function Description
#######################################################################################################################
"""
This function calculates the electrical output of the transformer.
Inputs:     1) t:       time domain vector (sec)
            2) i_p:     time domain primary current (A)
            3) i_s:     time domain secondary current (A)
            4) v_p:     time domain primary voltage (V)
            5) v_s:     time domain secondary voltage (V)
            6) Ttra:    transformer temperature (Â°C)
            7) para:    all parameters of the transformer
            8) setup:   all setup variables
Outputs:    1) out:     time domain transformer electrical quantities (i_p, i_s, i_m, v_p, v_s, Phi, B)
"""

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================

# ==============================================================================
# External
# ==============================================================================
import numpy as np
import pandas as pd


#######################################################################################################################
# Function
#######################################################################################################################
def calcElecTra(t, i_p, i_s, v_p, v_s, Ttra, para, setup):
    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    # ==============================================================================
    # Output
    # ==============================================================================
    out = pd.DataFrame(columns=['i_p', 'i_s', 'i_m', 'v_p', 'v_s', 'Phi', 'B'])

    ###################################################################################################################
    # Pre-Processing
    ###################################################################################################################
    # ==============================================================================
    # Parameters
    # ==============================================================================
    N = para['Tra']['Elec']['con']['N']
    Np = para['Tra']['Elec']['con']['Np']
    Ae = para['Tra']['Elec']['con']['A']

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    # Currents and Voltages
    out['i_p'] = i_p
    out['i_s'] = i_s
    out['v_p'] = v_p
    out['v_s'] = v_s

    # Magnetizing Current
    out['i_m'] = i_p - (i_s / N)

    # Magnetic Flux
    dt = t[1] - t[0]
    out['Phi'] = np.cumsum(v_p) * dt / Np
    out['Phi'] = out['Phi'] - np.mean(out['Phi'])

    # Magnetic Flux Density
    out['B'] = out['Phi'] / Ae

    ###################################################################################################################
    # Return
    ###################################################################################################################
    return out
