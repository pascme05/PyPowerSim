#######################################################################################################################
#######################################################################################################################
# Title:        PWM Distortion Toolkit for Standard Topologies
# Topic:        Power Electronics
# File:         outB6
# Date:         01.05.2024
# Author:       Dr. Pascal A. Schirmer
# Version:      V.1.0
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Function Description
#######################################################################################################################
"""
This function summarizes the calculated outputs for the B6 bridge circuit.
Inputs:     1) timeAc:  time domain ac results
            2) timeDc:  time domain dc results
            3) freqSw:  frequency domain results switching function
            4) freqAc:  frequency domain results ac
            5) freqDc:  frequency domain results dc
            6) t_ref:   reference time vector (sec)
            7) v_ref:   reference voltage vector (V)
            8) e_ref:   reference back EMI vector (V)
            9) s:       switching function
            10) c:      carrier waveform
            11) xs:     sampled reference
            12) xsh:    sampled reference including zero order hold
            13) K:      number of fundamental cycles
            14) Nsim:   number of samples in fundamental period
            15) Tel:    period of the fundamental
            16) Nel:    number of electrical cycles in transient period
Outputs:    1) time:    results in the time domain
            2) freq:    results in the frequency domain
            3) dist:    results in the distortion domain
"""

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================
from src.topo.B6.initB6 import initB6

# ==============================================================================
# External
# ==============================================================================
import numpy as np


#######################################################################################################################
# Function
#######################################################################################################################
def outB6_Trans(out, timeAc, timeDc, freqSw, freqAc, freqDc, t_ref, v_ref, e_ref, s, c, xs, xsh, x, n0, K, Nsim, Tel, Nel):
    ###################################################################################################################
    # Init Values
    ###################################################################################################################
    # ==============================================================================
    # Variables
    # ==============================================================================
    time = {}
    freq = {}

    # ==============================================================================
    # Struct
    # ==============================================================================
    [timeSw, _, _, _, _, _, _, _, _] = initB6(5)

    ###################################################################################################################
    # Output Values
    ###################################################################################################################
    # ==============================================================================
    # General
    # ==============================================================================
    timeSw['t'] = t_ref[0:((K * Nsim + 1) - Nsim)]
    timeSw['v_a_ref'] = v_ref['A'][Nsim:(K * Nsim + 1)]
    timeSw['v_b_ref'] = v_ref['B'][Nsim:(K * Nsim + 1)]
    timeSw['v_c_ref'] = v_ref['C'][Nsim:(K * Nsim + 1)]
    timeSw['e_a'] = e_ref['A'][Nsim:(K * Nsim + 1)]
    timeSw['e_b'] = e_ref['B'][Nsim:(K * Nsim + 1)]
    timeSw['e_c'] = e_ref['C'][Nsim:(K * Nsim + 1)]
    timeSw['sA'] = s['A'][Nsim:(K * Nsim + 1)]
    timeSw['sB'] = s['B'][Nsim:(K * Nsim + 1)]
    timeSw['sC'] = s['C'][Nsim:(K * Nsim + 1)]
    timeSw['c'] = c[Nsim:(K * Nsim + 1)]
    timeSw['xAs'] = xs['A'][Nsim:(K * Nsim + 1)]
    timeSw['xBs'] = xs['B'][Nsim:(K * Nsim + 1)]
    timeSw['xCs'] = xs['C'][Nsim:(K * Nsim + 1)]
    timeSw['xAsh'] = xsh['A'][Nsim:(K * Nsim + 1)]
    timeSw['xBsh'] = xsh['B'][Nsim:(K * Nsim + 1)]
    timeSw['xCsh'] = xsh['C'][Nsim:(K * Nsim + 1)]
    timeSw['xA'] = x['A'][Nsim:(K * Nsim + 1)]
    timeSw['xB'] = x['B'][Nsim:(K * Nsim + 1)]
    timeSw['xC'] = x['C'][Nsim:(K * Nsim + 1)]
    timeSw['n0'] = n0[Nsim:(K * Nsim + 1)]

    # ==============================================================================
    # Combine
    # ==============================================================================
    # ------------------------------------------
    # Time
    # ------------------------------------------
    time['Sw'] = timeSw
    time['Ac'] = timeAc
    time['Dc'] = timeDc
    time['t'] = np.linspace(0, Tel * Nel, int(len(out['loss']['sw']['S1']['p_T'])))
    time['Elec'] = out['elec']
    time['Loss'] = out['loss']
    time['Ther'] = out['ther']

    # ------------------------------------------
    # Frequency
    # ------------------------------------------
    freq['Sw'] = freqSw
    freq['Ac'] = freqAc
    freq['Dc'] = freqDc

    ###################################################################################################################
    # Outputs
    ###################################################################################################################
    return [time, freq]


#######################################################################################################################
# Function
#######################################################################################################################
def outB6_Steady(timeElec, timeLoss, timeTher, timeAc, timeDc, freqSw, freqAc, freqDc, t, v_ref, e_ref, s, c, xs, xsh, x, n0, W, ende, start):
    ###################################################################################################################
    # Init Values
    ###################################################################################################################
    # ==============================================================================
    # Variables
    # ==============================================================================
    time = {}
    freq = {}

    # ==============================================================================
    # Struct
    # ==============================================================================
    [timeSw, _, _, _, _, _, _, _, _] = initB6(W)

    ###################################################################################################################
    # Output Values
    ###################################################################################################################
    # ==============================================================================
    # General
    # ==============================================================================
    timeSw['t'] = t[0:(ende - start)]
    timeSw['v_a_ref'] = v_ref['A'][start:ende]
    timeSw['v_b_ref'] = v_ref['B'][start:ende]
    timeSw['v_c_ref'] = v_ref['C'][start:ende]
    timeSw['e_a'] = e_ref['A'][start:ende]
    timeSw['e_b'] = e_ref['B'][start:ende]
    timeSw['e_c'] = e_ref['C'][start:ende]
    timeSw['sA'] = s['A'][start:ende]
    timeSw['sB'] = s['B'][start:ende]
    timeSw['sC'] = s['C'][start:ende]
    timeSw['c'] = c[start:ende]
    timeSw['xAs'] = xs['A'][start:ende]
    timeSw['xBs'] = xs['B'][start:ende]
    timeSw['xCs'] = xs['C'][start:ende]
    timeSw['xAsh'] = xsh['A'][start:ende]
    timeSw['xBsh'] = xsh['B'][start:ende]
    timeSw['xCsh'] = xsh['C'][start:ende]
    timeSw['xA'] = x['A'][start:ende]
    timeSw['xB'] = x['B'][start:ende]
    timeSw['xC'] = x['C'][start:ende]
    timeSw['n0'] = n0[start:ende]

    # ==============================================================================
    # Combine
    # ==============================================================================
    # ------------------------------------------
    # Time
    # ------------------------------------------
    time['Sw'] = timeSw
    time['Ac'] = timeAc
    time['Dc'] = timeDc
    time['Elec'] = timeElec
    time['Loss'] = timeLoss
    time['Ther'] = timeTher

    # ------------------------------------------
    # Frequency
    # ------------------------------------------
    freq['Sw'] = freqSw
    freq['Ac'] = freqAc
    freq['Dc'] = freqDc

    ###################################################################################################################
    # Outputs
    ###################################################################################################################
    return [time, freq]


#######################################################################################################################
# Function
#######################################################################################################################
def outB6_Sweep(distAc, distDc, timeAc, timeDc, freqSw, freqAc, freqDc, t, v_ref, e_ref, s, c, xs, xsh, x, n0, W, M_i, ende, start):
    ###################################################################################################################
    # Init Values
    ###################################################################################################################
    # ==============================================================================
    # Variables
    # ==============================================================================
    time = {}
    freq = {}
    sweep = {}

    # ==============================================================================
    # Struct
    # ==============================================================================
    [timeSw, _, _, _, _, _, _, _, _] = initB6(W)

    ###################################################################################################################
    # Output Values
    ###################################################################################################################
    # ==============================================================================
    # General
    # ==============================================================================
    timeSw['t'] = t[0:(ende - start)]
    timeSw['v_a_ref'] = v_ref['A'][start:ende]
    timeSw['v_b_ref'] = v_ref['B'][start:ende]
    timeSw['v_c_ref'] = v_ref['C'][start:ende]
    timeSw['e_a'] = e_ref['A'][start:ende]
    timeSw['e_b'] = e_ref['B'][start:ende]
    timeSw['e_c'] = e_ref['C'][start:ende]
    timeSw['sA'] = s['A'][start:ende]
    timeSw['sB'] = s['B'][start:ende]
    timeSw['sC'] = s['C'][start:ende]
    timeSw['c'] = c[start:ende]
    timeSw['xAs'] = xs['A'][start:ende]
    timeSw['xBs'] = xs['B'][start:ende]
    timeSw['xCs'] = xs['C'][start:ende]
    timeSw['xAsh'] = xsh['A'][start:ende]
    timeSw['xBsh'] = xsh['B'][start:ende]
    timeSw['xCsh'] = xsh['C'][start:ende]
    timeSw['xA'] = x['A'][start:ende]
    timeSw['xB'] = x['B'][start:ende]
    timeSw['xC'] = x['C'][start:ende]
    timeSw['n0'] = n0[start:ende]

    # ==============================================================================
    # Combine
    # ==============================================================================
    # ------------------------------------------
    # Time
    # ------------------------------------------
    time['Sw'] = timeSw
    time['Ac'] = timeAc
    time['Dc'] = timeDc

    # ------------------------------------------
    # Frequency
    # ------------------------------------------
    freq['Sw'] = freqSw
    freq['Ac'] = freqAc
    freq['Dc'] = freqDc

    # ------------------------------------------
    # Sweep
    # ------------------------------------------
    sweep['Ac'] = distAc
    sweep['Dc'] = distDc
    sweep['Mi'] = M_i

    ###################################################################################################################
    # Outputs
    ###################################################################################################################
    return [time, freq, sweep]
