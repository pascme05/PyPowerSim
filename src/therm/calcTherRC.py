#######################################################################################################################
#######################################################################################################################
# Title:        PWM Distortion Toolkit for Standard Topologies
# Topic:        Power Electronics
# File:         calcTherRC
# Date:         01.05.2024
# Author:       Dr. Pascal A. Schirmer
# Version:      V.1.0
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Function Description
#######################################################################################################################
"""
This function calculates the time domain transient thermal response of a 1D reduced order model using RC parameters.
Inputs:     1) Tinit:   initial temperature per RC pair (°C)
            2) Tc:      coolant reference temperature (°C)
            3) Pv:      power losses (W)
            4) t:       time domain vector (sec)
            5) Rth:     thermal resistances (K/W)
            6) Cth:     thermal capacitance (Ws/K)
Outputs:    1) dT:      self-heating (K)
            2) T:       absolute temperature (°C)
"""

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================

# ==============================================================================
# External
# ==============================================================================
import numpy as np


#######################################################################################################################
# Function
#######################################################################################################################
def calcTherRC(Tinit, Tc, Pv, t, Rth, Cth):
    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    # ==============================================================================
    # Parameters
    # ==============================================================================
    N = len(Pv)
    K = len(Rth)
    tau = Rth*Cth

    # ==============================================================================
    # Variables
    # ==============================================================================
    dt = np.diff(t)
    dt = np.insert(dt, len(dt), dt)
    T = Tinit*np.ones((N, K))

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    for i in range(1, N):
        T[i, :] = (2*tau[:]-dt[i])/(2*tau[:]+dt[i])*T[i-1, :] + (Rth[:]*dt[i])/(2*tau[:]+dt[i])*(Pv[i]+Pv[i-1])

    ###################################################################################################################
    # Post-Processing
    ###################################################################################################################
    Tj = np.sum(T, axis=1) + Tc
    Tend = T[-1, :]

    ###################################################################################################################
    # Return
    ###################################################################################################################
    return [Tj, Tend]
