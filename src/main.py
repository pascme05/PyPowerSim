#######################################################################################################################
#######################################################################################################################
# Title:        PWM Distortion Toolkit for Standard Topologies
# Topic:        Power Electronics
# File:         main
# Date:         16.12.2025
# Author:       Dr. Pascal A. Schirmer
# Version:      V.1.1
# Copyright:    Pascal Schirmer
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
# Function Description
#######################################################################################################################
"""
This function builds the main part of the simulation. It takes the setup files and path variables as input and
executes the program.
Inputs:     1) setup:   includes all simulation variables
            2) path:    includes all path variables
Outputs:    None

V1.1: 16.12.2025, Pascal Schirmer
- Added timing summary for each stage of the simulation
"""

#######################################################################################################################
# Import libs
#######################################################################################################################
# ==============================================================================
# Internal
# ==============================================================================
from src.data.loadPara import loadPara
from src.data.loadSetup import loadSetup
from src.mode.inv.calcSweep import calcSweep
from src.mode.inv.calcSteady import calcSteady
from src.mode.inv.calcTrans import calcTrans
from src.mode.inv.calcClose import calcClose
from src.mode.dcdc.calcSweep_DCDC import calcSweep_DCDC
from src.mode.dcdc.calcSteady_DCDC import calcSteady_DCDC
from src.mode.dcdc.calcTrans_DCDC import calcTrans_DCDC
from src.mode.dcdc.calcClose_DCDC import calcClose_DCDC
from src.topo.initTopo import initTopo
from src.plot.plot import plot
from src.plot.plotResults import plotResults
from src.plot.plotResults_DCDC import plotResults_DCDC
from src.general.genTF import genTF
from src.general.sanityCheck import sanityInput
from src.general.saveResults import saveResults
from src.general.genLoadInput import genLoadInput

# ==============================================================================
# External
# ==============================================================================
import sys
import time


#######################################################################################################################
# Steady-State
#######################################################################################################################
def main(setup, path):
    ###################################################################################################################
    # MSG IN
    ###################################################################################################################
    print("----------------------------------------------------------------------------------------------------------")
    print("----------------------------------------------------------------------------------------------------------")
    print("Welcome to the Power Electronics Distortion Toolkit!")
    print("Author:     Dr. Pascal Alexander Schirmer")
    print("Copyright:  Pascal Schirmer")
    print("Version:    v.1.0")
    print("Date:       27.04.2024")
    print("----------------------------------------------------------------------------------------------------------")
    print("----------------------------------------------------------------------------------------------------------")

    ###################################################################################################################
    # Initialisation
    ###################################################################################################################
    # ==============================================================================
    # Variables
    # ==============================================================================
    time_var = []
    freq = []
    sweep = []

    # ==============================================================================
    # Timing
    # ==============================================================================
    total_start = time.perf_counter()
    stage_times = {}

    ###################################################################################################################
    # Loading
    ###################################################################################################################
    # ==============================================================================
    # MSG IN
    # ==============================================================================
    print("=======================================================================")
    print("START: Loading")
    print("=======================================================================")
    timeStart = time.perf_counter()

    # ==============================================================================
    # Configuration
    # ==============================================================================
    try:
        setup = loadSetup(setup, path)
    except:
        sys.exit('ERROR: Configuration could not be loaded')

    # ==============================================================================
    # Parameter
    # ==============================================================================
    try:
        para = loadPara(setup, path)
    except:
        sys.exit('ERROR: Parameters could not be loaded')

    # ==============================================================================
    # MSG OUT
    # ==============================================================================
    timeEnd = time.perf_counter()
    stage_times['Loading'] = timeEnd - timeStart
    print("=======================================================================")
    print("END: Loading")
    print("=======================================================================")
    print("\n")

    ###################################################################################################################
    # Pre-Processing
    ###################################################################################################################
    # ==============================================================================
    # MSG IN
    # ==============================================================================
    print("=======================================================================")
    print("START: Pre-Processing")
    print("=======================================================================")
    timeStart = time.perf_counter()

    # ==============================================================================
    # Sanity Checks
    # ==============================================================================
    setup = sanityInput(para, setup)

    # ==============================================================================
    # Transfer Functions
    # ==============================================================================
    mdl = genTF(para, setup)

    # ==============================================================================
    # Control Mode
    # ==============================================================================
    setup = genLoadInput(setup, para)

    # ==============================================================================
    # MSG OUT
    # ==============================================================================
    timeEnd = time.perf_counter()
    stage_times['Pre-Processing'] = timeEnd - timeStart
    print("=======================================================================")
    print("END: Pre-Processing")
    print("=======================================================================")
    print("\n")

    ###################################################################################################################
    # Calculation
    ###################################################################################################################
    # ==============================================================================
    # MSG IN
    # ==============================================================================
    print("=======================================================================")
    print("START: Simulation")
    print("=======================================================================")
    timeStart = time.perf_counter()

    # ==============================================================================
    # Init Topology
    # ==============================================================================
    top = initTopo(setup['Top']['sourceType'], setup, para)

    # ==============================================================================
    # Operating Mode
    # ==============================================================================
    # ------------------------------------------
    # Sweep
    # ------------------------------------------
    if setup['Exp']['type'] == 0:
        # DCDC
        if setup['Top']['sourceType'] == "DAB":
            [time_var, freq, sweep] = calcSweep_DCDC(top, mdl, para, setup)
        else:
            [time_var, freq, sweep] = calcSweep(top, mdl, para, setup)

    # ------------------------------------------
    # Stationary
    # ------------------------------------------
    elif setup['Exp']['type'] == 1:
        if setup['Top']['sourceType'] == "DAB":
            [time_var, freq] = calcSteady_DCDC(top, mdl, para, setup)
        else:
            [time_var, freq] = calcSteady(top, mdl, para, setup)

    # ------------------------------------------
    # Transient
    # ------------------------------------------
    elif setup['Exp']['type'] == 2:
        if setup['Top']['sourceType'] == "DAB":
            [time_var, freq] = calcTrans_DCDC(top, mdl, para, setup)
        else:
            [time_var, freq] = calcTrans(top, mdl, para, setup)

    # ------------------------------------------
    # Closed Loop
    # ------------------------------------------
    elif setup['Exp']['type'] == 3:
        if setup['Top']['sourceType'] == "DAB":
            [time_var, freq] = calcClose_DCDC(top, mdl, para, setup)
        else:
            [time_var, freq] = calcClose(top, mdl, para, setup)

    # ------------------------------------------
    # Default
    # ------------------------------------------
    else:
        print("ERROR: Invalid operation or topology")

    # ==============================================================================
    # MSG OUT
    # ==============================================================================
    timeEnd = time.perf_counter()
    stage_times['Simulation'] = timeEnd - timeStart
    print("=======================================================================")
    print("END: Simulation")
    print("=======================================================================")
    print("\n")

    ###################################################################################################################
    # Post-Processing
    ###################################################################################################################
    # ==============================================================================
    # MSG IN
    # ==============================================================================
    print("=======================================================================")
    print("START: Post-Processing")
    print("=======================================================================")
    timeStart = time.perf_counter()

    # ==============================================================================
    # Save Results
    # ==============================================================================
    if setup['Exp']['save'] == 1:
        saveResults(time_var, freq, sweep, setup, path)

    # ==============================================================================
    # Plot Results
    # ==============================================================================
    if setup['Exp']['type'] == 1 or setup['Exp']['type'] == 2:
        if setup['Top']['sourceType'] == "DAB":
            plotResults_DCDC(time_var, setup)
        else:
            plotResults(time_var, setup)

    # ==============================================================================
    # Plot Results
    # ==============================================================================
    if setup['Exp']['plot'] != 0:
        plot(mdl, para, time_var, freq, sweep, setup)

    # ==============================================================================
    # MSG OUT
    # ==============================================================================
    timeEnd = time.perf_counter()
    stage_times['Post-Processing'] = timeEnd - timeStart
    print("=======================================================================")
    print("END: Post-Processing")
    print("=======================================================================")
    print("\n")

    ###################################################################################################################
    # Timing summary
    ###################################################################################################################
    # ==============================================================================
    # Calculation
    # ==============================================================================
    total_end = time.perf_counter()
    stage_times['Total'] = total_end - total_start

    # ==============================================================================
    # Print Summary
    # ==============================================================================
    print("=======================================================================")
    print("TIMING SUMMARY (seconds):")
    for name, val in stage_times.items():
        print(f"  {name:15s}: {val:.6f}")
    print("=======================================================================")

    ###################################################################################################################
    # MSG Out
    ###################################################################################################################
